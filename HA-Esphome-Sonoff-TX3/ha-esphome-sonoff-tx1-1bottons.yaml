# ===========================================================================
# RESUMEN DE CARACTERÍSTICAS ESPHOME SONOFF TX1 EU  ->  [ 1 BUTTON ]
# ===========================================================================
# 
# HARDWARE:
#   - Chip: ESP8285 (1MB Flash)
#   - Board: T0EU1C Touch v1.0
#   - Botón táctil: GPIO0
#   - Relé: GPIO12
#   - LED azul: GPIO13 (PWM controlable)
#   - Buzzer: NO CONTROLABLE (conectado al chip EFM8BB1, no al ESP)
#
# LED AZUL (Retroiluminación):
#   - TODOS los gestos activan feedback visual
#   - Pulsación corta: 1 parpadeo (400ms al 100%)
#   - Doble pulsación: 2 parpadeos (400ms cada uno)
#   - Pulsación larga: Parpadeo prolongado (800ms al 100%)
#   - Brillo por defecto: 30%
#
# CONTROL DE RELÉ:
#   - Relé = entidad "light" (luz_1) + entidad "switch" (sw_1)
#   - Sincronización perfecta entre ambas entidades
#   - Al cambiar una, automáticamente se actualiza la otra
#
# MODO DESACOPLADO:
#   - false = Botón controla el relé directamente
#   - true = Botón solo envía eventos (no controla relé)
#
# EVENTOS DISPONIBLES:
#   - 3 sensores binarios para automatizaciones en Home Assistant
#   - corto_1, doble_1, largo_1
#
#
# NOTAS TÉCNICAS:
#   - restore_from_flash: true (para ESP8266, mejora la persistencia)
#   - baud_rate: 0 (logging deshabilitado para liberar GPIO1/GPIO3)
#   - INPUT_PULLUP en botón (necesario para táctil)
#   - inverted: true en LED (ánodo común)
#
# ===========================================================================

substitutions:
  # === IDENTIFICACIÓN ===
  uniquename: "esp-dormitorio-b"    # Nombre Unico
  friendly: "Esp Dormitorio B"      # Nombre Amigable
  device_name: "TX1 UE WiFi"        # Modelo o tipo
  device_make: "Sonoff"             # Fabricante
  chip: "ESP 8285"                  # Chip Esp 

  # === RED ===
  info_mac : "XX:XX:XX:XX:XX:XX"    # Solo informativo
  info_ip : "192.168.1.XX"          # Solo informativo

  # === CREDENCIALES ===
  data_ssid: !secret wifi_ssid
  data_ssid_pass: !secret wifi_password

  apikey: !secret esp_dormitorio_b_apikey  
  ota_password: !secret esp_dormitorio_b_ota_password
   
  # === MODO DESACOPLADO ===
  rele_1_independiente : "false"    # false = botón controla relé    # true = relé desacoplado


globals:
  - id: var_rele1_independiente
    type: bool
    initial_value: "${rele_1_independiente}"
  - id: backlight_enabled
    type: bool
    initial_value: "true"


esp8266:
  board: esp01_1m
  restore_from_flash: true

esphome:
  name: "${uniquename}"
  friendly_name: "${friendly}"
  comment: "${device_name} by ${device_make} - ${chip}"
  on_boot:
    - priority: -100
      then:
        - light.turn_on: {id: backlight, brightness: 30%}
        - binary_sensor.template.publish: {id: corto_1, state: false}
        - binary_sensor.template.publish: {id: doble_1, state: false}
        - binary_sensor.template.publish: {id: largo_1, state: false}

logger:
  level: INFO
  baud_rate: 0  # Deshabilitar logging por UART

api:
  encryption:
    key: "${apikey}"

ota:
  - platform: esphome
    password: "${ota_password}"

wifi:
  fast_connect: false
  power_save_mode: none
  ssid: "${data_ssid}"
  password: "${data_ssid_pass}"
  ap:
    ssid: "${device_name}-setup"
    password: !secret wifi_password_setup

captive_portal:


# ===========================================================================
# OUTPUTS - RELÉ Y BACKLIGHT
# ===========================================================================
output:
  # LED AZUL - Retroiluminación con PWM
  - platform: esp8266_pwm
    id: backlight_pwm
    pin: GPIO13
    inverted: true
    frequency: 1000 Hz
    
  # RELÉ
  - platform: gpio
    id: relay_output_1
    pin: GPIO12


# ===========================================================================
# LUCES - Control principal del relé
# ===========================================================================
light:
  # BACKLIGHT - LED AZUL
  - platform: monochromatic
    id: backlight
    output: backlight_pwm
    internal: true
    restore_mode: ALWAYS_ON

  # RELÉ COMO LUZ - CON SINCRONIZACIÓN
  - platform: binary
    id: luz_1
    name: "Luz 1"
    output: relay_output_1
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_on: sw_1
    on_turn_off:
      - switch.turn_off: sw_1


# ===========================================================================
# SWITCHES - Control alternativo del relé
# ===========================================================================
switch:
  - platform: output
    id: sw_1  
    name: "Sw 1"
    output: relay_output_1
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - light.turn_on: luz_1
    on_turn_off:
      - light.turn_off: luz_1


# ===========================================================================
# SENSORES DE GESTOS - Para automatizaciones en Home Assistant
# ===========================================================================
binary_sensor:
  # PULSACIÓN CORTA (< 600ms)
  - platform: template
    id: corto_1
    name: "Corto 1"

  # DOBLE PULSACIÓN
  - platform: template
    id: doble_1
    name: "Doble 1"

  # PULSACIÓN LARGA (> 800ms)
  - platform: template
    id: largo_1
    name: "Largo 1"


  # ===========================================================================
  # BOTÓN 1 - GPIO0
  # ===========================================================================
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    id: tactil_1_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Feedback LED azul
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele1_independiente);'
              then:
                - light.toggle: luz_1
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_1, state: true}
          # Feedback visual: LED azul
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_1, state: false}

      # DOBLE PULSACIÓN - Feedback LED azul
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_1, state: true}
          # Feedback visual: LED azul doble parpadeo
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_1, state: false}

      # PULSACIÓN LARGA - Feedback LED azul
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_1, state: true}
          # Feedback visual: LED azul prolongado
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_1, state: false}
