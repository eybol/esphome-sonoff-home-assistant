# ===========================================================================
# RESUMEN DE CARACTERÍSTICAS ESPHOME SONOFF M5-2C 86 ->  [ 2 BUTTONS ]
# ===========================================================================
# 
# HARDWARE:
#   - Chip: ESP32-D0WD v3
#   - Board: MM5-2C 86
#   - Botones táctiles capacitivos: GPIO4, GPIO0
#   - Relés: GPIO23, GPIO19
#   - Backlight RGB: GPIO18 (PWM controlable - LED blanco)
#   - LED de estado: GPIO5 (invertido)
#   - Buzzer: NO CONTROLABLE (si existe, conectado al chip CST816S, no al ESP32)
#
# BACKLIGHT (Retroiluminación):
#   - TODOS los gestos (corto, doble, largo) activan luz nocturna
#   - Duración: 400-800ms al 100% de brillo según gesto
#   - Después regresa automáticamente al 30%
#   - Útil para ver el interruptor en la oscuridad
#   - LED monocromático (aunque es RGB físicamente, se usa como blanco)
#
# CONTROL DE RELÉS:
#   - Cada relé = entidad "light" (luz_X) + entidad "switch" (sw_X)
#   - Sincronización perfecta entre ambas entidades
#   - Al cambiar una, automáticamente se actualiza la otra
#   - Funciona desde: botones físicos, Home Assistant, o automaciones
#
# MODO DESACOPLADO:
#   - false = Botón controla el relé directamente (por defecto)
#   - true = Botón solo envía eventos (no controla relé)
#   - Configurable independientemente para cada botón/relé
#
# EVENTOS DISPONIBLES:
#   - 6 sensores binarios para automatizaciones en Home Assistant
#   - corto_X: Pulsación < 600ms (alterna relé si no está desacoplado)
#   - doble_X: Doble pulsación rápida (< 400ms cada una)
#   - largo_X: Pulsación > 800ms (mantener presionado)
#   - Donde X = 1, 2 (uno por cada botón)
#
# FEEDBACK VISUAL POR GESTO:
#   - Pulsación corta: 1 destello rápido (400ms al 100%)
#   - Doble pulsación: 2 destellos (400ms cada uno, separados 400ms)
#   - Pulsación larga: 1 destello prolongado (800ms al 100%)
#
# SINCRONIZACIÓN LIGHT/SWITCH:
#   - Presionar botón físico → Alterna luz → Luz sincroniza switch 
#   - Cambiar luz en HA → Luz sincroniza switch 
#   - Cambiar switch en HA → Switch sincroniza luz
#   - Implementado con on_turn_on/off en ambas direcciones
#
# NOTAS TÉCNICAS:
#   - Framework: Arduino (estable para ESP32)
#   - WiFi: power_save_mode: none (mejor respuesta táctil)
#   - fast_connect: false (mejor compatibilidad)
#   - Restore mode: ALWAYS_OFF (relés apagados tras reinicio)
#   - Backlight restore: ALWAYS_ON (siempre al 30% tras reinicio)
#
# ===========================================================================

substitutions:
  # === IDENTIFICACIÓN ===
  uniquename: "esp-salon-a"             # Nombre Unico
  friendly: "Esp Salon A"               # Nombre Amigable
  device_name: "MM5-2C 86"              # Modelo o tipo
  device_make: "Sonoff"                 # Fabricante
  chip: "esp32-d0wd v3"                 # Chip Esp 

  # === RED ===
  info_mac : "XX:XX:XX:XX:XX:XX"        # Solo informativo
  info_ip : "192.168.1.XX"              # Solo informativo

  # === CREDENCIALES ===
  data_ssid: !secret wifi_ssid
  data_ssid_pass: !secret wifi_password
  apikey: !secret esp_salon_a_apikey  
  ota_password: !secret esp_salon_a_ota_password
   
  # === MODO DESACOPLADO ===
  rele_1_independiente : "false"      # false = botón controla relé    # true = relé desacoplado
  rele_2_independiente : "false"      # false = botón controla relé    # true = relé desacoplado
  
# ===========================================================================
# ===========================================================================
# ===========================================================================

globals:
  - id: var_rele1_independiente
    type: bool
    initial_value: "${rele_1_independiente}"
  - id: var_rele2_independiente
    type: bool
    initial_value: "${rele_2_independiente}"
  - id: backlight_enabled
    type: bool
    initial_value: "true"


esp32:
  variant: esp32
  framework:
    type: arduino

esphome:
  name: "${uniquename}"
  friendly_name: "${friendly}"
  comment: "${device_name} by ${device_make} - ${chip}"
  on_boot:
    - priority: -100
      then:
        - light.turn_on: {id: backlight, brightness: 30%}
        - binary_sensor.template.publish: {id: corto_1, state: false}
        - binary_sensor.template.publish: {id: corto_2, state: false}
        - binary_sensor.template.publish: {id: doble_1, state: false}
        - binary_sensor.template.publish: {id: doble_2, state: false}
        - binary_sensor.template.publish: {id: largo_1, state: false}
        - binary_sensor.template.publish: {id: largo_2, state: false}

logger:
  level: INFO

api:
  encryption:
    key: "${apikey}"

ota:
  - platform: esphome
    password: "${ota_password}"

wifi:
  fast_connect: false
  power_save_mode: none
  ssid: "${data_ssid}"
  password: "${data_ssid_pass}"
  ap:
    ssid: "${device_name}-setup"
    password: !secret wifi_password_setup

captive_portal:

status_led:
  pin:
    number: GPIO5
    inverted: true


# ===========================================================================
# OUTPUTS - RELÉS Y BACKLIGHT
# ===========================================================================
output:
  - platform: ledc
    id: backlight_pwm
    pin: GPIO18
    frequency: 1000 Hz
  - platform: gpio
    id: relay_output_1
    pin: GPIO23
  - platform: gpio
    id: relay_output_2
    pin: GPIO19


# ===========================================================================
# LUCES - Control principal de los relés
# ===========================================================================
light:
  # BACKLIGHT
  - platform: monochromatic
    id: backlight
    output: backlight_pwm
    internal: true
    restore_mode: ALWAYS_ON

  # RELÉS COMO LUCES - CON SINCRONIZACIÓN
  - platform: binary
    id: luz_1
    name: "Luz 1"
    output: relay_output_1
    restore_mode: ALWAYS_OFF
    on_turn_on:
      - switch.turn_on: sw_1
    on_turn_off:
      - switch.turn_off: sw_1
      
  - platform: binary
    id: luz_2
    name: "Luz 2"
    output: relay_output_2
    restore_mode: ALWAYS_OFF
    on_turn_on:
      - switch.turn_on: sw_2
    on_turn_off:
      - switch.turn_off: sw_2


# ===========================================================================
# SWITCHES - Control alternativo de los relés
# ===========================================================================
switch:
  - platform: output
    id: sw_1  
    name: "Sw 1"
    output: relay_output_1
    restore_mode: ALWAYS_OFF
    on_turn_on:
      - light.turn_on: luz_1
    on_turn_off:
      - light.turn_off: luz_1
      
  - platform: output
    id: sw_2
    name: "Sw 2"
    output: relay_output_2
    restore_mode: ALWAYS_OFF
    on_turn_on:
      - light.turn_on: luz_2
    on_turn_off:
      - light.turn_off: luz_2


# ===========================================================================
# SENSORES DE GESTOS - Para automatizaciones en Home Assistant
# ===========================================================================
binary_sensor:
  # PULSACIONES CORTAS (< 600ms)
  - platform: template
    id: corto_1
    name: "Corto 1"
  - platform: template
    id: corto_2
    name: "Corto 2"

  # DOBLES PULSACIONES
  - platform: template
    id: doble_1
    name: "Doble 1"
  - platform: template
    id: doble_2
    name: "Doble 2"

  # PULSACIONES LARGAS (> 800ms)
  - platform: template
    id: largo_1
    name: "Largo 1"
  - platform: template
    id: largo_2
    name: "Largo 2"


  # ===========================================================================
  # BOTÓN 1 - GPIO4
  # ===========================================================================
  - platform: gpio
    pin: {number: GPIO4, inverted: true}
    id: tactil_1_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Luz nocturna 
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele1_independiente);'
              then:
                - light.toggle: luz_1
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_1, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_1, state: false}

      # DOBLE PULSACIÓN - Luz nocturna
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_1, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_1, state: false}

      # PULSACIÓN LARGA - Luz nocturna 
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_1, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_1, state: false}


  # ===========================================================================
  # BOTÓN 2 - GPIO0
  # ===========================================================================
  - platform: gpio
    pin: {number: GPIO0, inverted: true}
    id: tactil_2_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Luz nocturna 
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele2_independiente);'
              then:
                - light.toggle: luz_2
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_2, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_2, state: false}

      # DOBLE PULSACIÓN - Luz nocturna 
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_2, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_2, state: false}

      # PULSACIÓN LARGA - Luz nocturna 
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_2, state: true}
          # Feedback visual: Luz nocturna 
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_2, state: false}
