# ===========================================================================
# RESUMEN DE CARACTERÍSTICAS ESPHOME SONOFF TX3 EU  ->  [ 3 BUTTONS ]
# ===========================================================================
# 
# HARDWARE:
#   - Chip: ESP8285 (1MB Flash)
#   - Board: T0EU3C Touch v1.0
#   - Botones táctiles: GPIO0, GPIO9, GPIO10
#   - Relés: GPIO12, GPIO5, GPIO4
#   - LED azul: GPIO13 (PWM controlable)
#   - Buzzer: NO CONTROLABLE (conectado al chip EFM8BB1, no al ESP)
#
# LED AZUL (Retroiluminación):
#   - TODOS los gestos activan feedback visual
#   - Pulsación corta: 1 parpadeo (400ms al 100%)
#   - Doble pulsación: 2 parpadeos (400ms cada uno)
#   - Pulsación larga: Parpadeo prolongado (800ms al 100%)
#   - Brillo por defecto: 30%
#
# CONTROL DE RELÉS:
#   - Cada relé = entidad "light" (luz_X) + entidad "switch" (sw_X)
#   - Sincronización perfecta entre ambas entidades
#   - Al cambiar una, automáticamente se actualiza la otra
#
# MODO DESACOPLADO:
#   - false = Botón controla el relé directamente
#   - true = Botón solo envía eventos (no controla relé)
#
# EVENTOS DISPONIBLES:
#   - 9 sensores binarios para automatizaciones en Home Assistant
#   - corto_X, doble_X, largo_X (donde X = 1, 2, 3)
#
#
# NOTAS TÉCNICAS:
#   - restore_from_flash: true (para ESP8266, mejora la persistencia)
#   - baud_rate: 0 (logging deshabilitado para liberar GPIO1/GPIO3)
#   - INPUT_PULLUP en botones (necesario para táctiles)
#   - inverted: true en LED (ánodo común)
#
# ===========================================================================

substitutions:
  # === IDENTIFICACIÓN ===
  uniquename: "esp-escritorio-b"    # Nombre Unico
  friendly: "Esp Escritorio B"      # Nombre Amigable
  device_name: "TX3 UE WiFi"        # Modelo o tipo   ---- OJO ESTE ES DIFERENETE ES EL TACTIL   ---
  device_make: "Sonoff"             # Fabricante
  chip: "ESP 8285"                  # Chip Esp 

  # === RED ===
  info_mac : "E0:98:06:D6:6E:A1"    # Solo informativo
  info_ip : "192.168.1.55"          # Solo informativo

  # === CREDENCIALES ===
  data_ssid: !secret wifi_ssid
  data_ssid_pass: !secret wifi_password

  apikey: !secret esp_escritorio_b_apikey  
  ota_password: !secret esp_escritorio_b_ota_password
   
  # === MODO DESACOPLADO ===
  rele_1_independiente : "false"    # false = botón controla relé    # true = relé desacoplado
  rele_2_independiente : "false"    # false = botón controla relé    # true = relé desacoplado
  rele_3_independiente : "false"    # false = botón controla relé    # true = relé desacoplado


globals:
  - id: var_rele1_independiente
    type: bool
    initial_value: "${rele_1_independiente}"
  - id: var_rele2_independiente
    type: bool
    initial_value: "${rele_2_independiente}"
  - id: var_rele3_independiente
    type: bool
    initial_value: "${rele_3_independiente}"
  - id: backlight_enabled
    type: bool
    initial_value: "true"


esp8266:
  board: esp01_1m
  restore_from_flash: true

esphome:
  name: "${uniquename}"
  friendly_name: "${friendly}"
  comment: "${device_name} by ${device_make} - ${chip}"
  on_boot:
    - priority: -100
      then:
        - light.turn_on: {id: backlight, brightness: 30%}
        - binary_sensor.template.publish: {id: corto_1, state: false}
        - binary_sensor.template.publish: {id: corto_2, state: false}
        - binary_sensor.template.publish: {id: corto_3, state: false}
        - binary_sensor.template.publish: {id: doble_1, state: false}
        - binary_sensor.template.publish: {id: doble_2, state: false}
        - binary_sensor.template.publish: {id: doble_3, state: false}
        - binary_sensor.template.publish: {id: largo_1, state: false}
        - binary_sensor.template.publish: {id: largo_2, state: false}
        - binary_sensor.template.publish: {id: largo_3, state: false}

logger:
  level: INFO
  baud_rate: 0  # Deshabilitar logging por UART

api:
  encryption:
    key: "${apikey}"

ota:
  - platform: esphome
    password: "${ota_password}"

wifi:
  fast_connect: false
  power_save_mode: none
  ssid: "${data_ssid}"
  password: "${data_ssid_pass}"
  ap:
    ssid: "${device_name}-setup"
    password: !secret wifi_password_setup

captive_portal:


# ===========================================================================
# OUTPUTS - RELÉS Y BACKLIGHT
# ===========================================================================
output:
  # LED AZUL - Retroiluminación con PWM
  - platform: esp8266_pwm
    id: backlight_pwm
    pin: GPIO13
    inverted: true
    frequency: 1000 Hz
    
  # RELÉS
  - platform: gpio
    id: relay_output_1
    pin: GPIO12
  - platform: gpio
    id: relay_output_2
    pin: GPIO5
  - platform: gpio
    id: relay_output_3
    pin: GPIO4


# ===========================================================================
# LUCES - Control principal de los relés
# ===========================================================================
light:
  # BACKLIGHT - LED AZUL
  - platform: monochromatic
    id: backlight
    output: backlight_pwm
    internal: true
    restore_mode: ALWAYS_ON

  # RELÉS COMO LUCES - CON SINCRONIZACIÓN
  - platform: binary
    id: luz_1
    name: "Luz 1"
    output: relay_output_1
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_on: sw_1
    on_turn_off:
      - switch.turn_off: sw_1
      
  - platform: binary
    id: luz_2
    name: "Luz 2"
    output: relay_output_2
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_on: sw_2
    on_turn_off:
      - switch.turn_off: sw_2
      
  - platform: binary
    id: luz_3
    name: "Luz 3"
    output: relay_output_3
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_on: sw_3
    on_turn_off:
      - switch.turn_off: sw_3


# ===========================================================================
# SWITCHES - Control alternativo de los relés
# ===========================================================================
switch:
  - platform: output
    id: sw_1  
    name: "Sw 1"
    output: relay_output_1
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - light.turn_on: luz_1
    on_turn_off:
      - light.turn_off: luz_1
      
  - platform: output
    id: sw_2
    name: "Sw 2"
    output: relay_output_2
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - light.turn_on: luz_2
    on_turn_off:
      - light.turn_off: luz_2
      
  - platform: output
    id: sw_3
    name: "Sw 3"
    output: relay_output_3
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - light.turn_on: luz_3
    on_turn_off:
      - light.turn_off: luz_3


# ===========================================================================
# SENSORES DE GESTOS - Para automatizaciones en Home Assistant
# ===========================================================================
binary_sensor:
  # PULSACIONES CORTAS (< 600ms)
  - platform: template
    id: corto_1
    name: "Corto 1"
  - platform: template
    id: corto_2
    name: "Corto 2"
  - platform: template
    id: corto_3
    name: "Corto 3"

  # DOBLES PULSACIONES
  - platform: template
    id: doble_1
    name: "Doble 1"
  - platform: template
    id: doble_2
    name: "Doble 2"
  - platform: template
    id: doble_3
    name: "Doble 3"

  # PULSACIONES LARGAS (> 800ms)
  - platform: template
    id: largo_1
    name: "Largo 1"
  - platform: template
    id: largo_2
    name: "Largo 2"
  - platform: template
    id: largo_3
    name: "Largo 3"


  # ===========================================================================
  # BOTÓN 1 - GPIO0
  # ===========================================================================
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    id: tactil_1_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Feedback LED azul
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele1_independiente);'
              then:
                - light.toggle: luz_1
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_1, state: true}
          # Feedback visual: LED azul
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_1, state: false}

      # DOBLE PULSACIÓN - Feedback LED azul
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_1, state: true}
          # Feedback visual: LED azul doble parpadeo
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_1, state: false}

      # PULSACIÓN LARGA - Feedback LED azul
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_1, state: true}
          # Feedback visual: LED azul prolongado
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_1, state: false}


  # ===========================================================================
  # BOTÓN 2 - GPIO9
  # ===========================================================================
  - platform: gpio
    pin:
      number: GPIO9
      mode: INPUT_PULLUP
      inverted: true
    id: tactil_2_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Feedback LED azul
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele2_independiente);'
              then:
                - light.toggle: luz_2
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_2, state: true}
          # Feedback visual: LED azul
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_2, state: false}

      # DOBLE PULSACIÓN - Feedback LED azul
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_2, state: true}
          # Feedback visual: LED azul doble parpadeo
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_2, state: false}

      # PULSACIÓN LARGA - Feedback LED azul
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_2, state: true}
          # Feedback visual: LED azul prolongado
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_2, state: false}


  # ===========================================================================
  # BOTÓN 3 - GPIO10
  # ===========================================================================
  - platform: gpio
    pin:
      number: GPIO10
      mode: INPUT_PULLUP
      inverted: true
    id: tactil_3_oculto
    internal: true
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_multi_click:
      # PULSACIÓN CORTA - Feedback LED azul
      - timing:
          - ON for at most 600ms
          - OFF for at least 400ms
        then:
          - if:
              condition:
                lambda: 'return !id(var_rele3_independiente);'
              then:
                - light.toggle: luz_3
          # Publica evento on
          - binary_sensor.template.publish: {id: corto_3, state: true}
          # Feedback visual: LED azul
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: corto_3, state: false}

      # DOBLE PULSACIÓN - Feedback LED azul
      - timing:
          - ON for at most 400ms
          - OFF for at most 300ms
          - ON for at most 400ms
          - OFF for at least 250ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: doble_3, state: true}
          # Feedback visual: LED azul doble parpadeo
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 400ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: doble_3, state: false}

      # PULSACIÓN LARGA - Feedback LED azul
      - timing:
          - ON for at least 800ms
        then:
          # Publica evento on
          - binary_sensor.template.publish: {id: largo_3, state: true}
          # Feedback visual: LED azul prolongado
          - light.turn_on: {id: backlight, brightness: 100%}
          - delay: 800ms
          - light.turn_on: {id: backlight, brightness: 30%}
          # Publica evento off
          - binary_sensor.template.publish: {id: largo_3, state: false}

